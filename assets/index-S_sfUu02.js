(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();const Z=0,me=3,Y=["#1a1a1a","#00f0f0","#0000f0","#f0a000","#f0f000","#00f000","#a000f0","#f00000"],oe=[883,816,750,683,616,550,466,366,283,183,166,150,133,116,100,100,83,83,66,66,50],O=[[[[0,1],[1,1],[2,1],[3,1]],[[2,0],[2,1],[2,2],[2,3]],[[0,2],[1,2],[2,2],[3,2]],[[1,0],[1,1],[1,2],[1,3]]],[[[0,0],[0,1],[1,1],[2,1]],[[1,0],[2,0],[1,1],[1,2]],[[0,1],[1,1],[2,1],[2,2]],[[1,0],[1,1],[0,2],[1,2]]],[[[2,0],[0,1],[1,1],[2,1]],[[1,0],[1,1],[1,2],[2,2]],[[0,1],[1,1],[2,1],[0,2]],[[0,0],[1,0],[1,1],[1,2]]],[[[1,0],[2,0],[1,1],[2,1]],[[1,0],[2,0],[1,1],[2,1]],[[1,0],[2,0],[1,1],[2,1]],[[1,0],[2,0],[1,1],[2,1]]],[[[1,0],[2,0],[0,1],[1,1]],[[1,0],[1,1],[2,1],[2,2]],[[1,1],[2,1],[0,2],[1,2]],[[0,0],[0,1],[1,1],[1,2]]],[[[1,0],[0,1],[1,1],[2,1]],[[1,0],[1,1],[2,1],[1,2]],[[0,1],[1,1],[2,1],[1,2]],[[1,0],[0,1],[1,1],[1,2]]],[[[0,0],[1,0],[1,1],[2,1]],[[2,0],[1,1],[2,1],[1,2]],[[0,1],[1,1],[1,2],[2,2]],[[1,0],[0,1],[1,1],[0,2]]]],Ce=[[[0,0,1],[-1,0,1],[-1,-1,1],[0,2,1],[-1,2,1]],[[0,0,1],[1,0,1],[1,1,1],[0,-2,1],[1,-2,1]],[[0,0,1],[1,0,1],[1,-1,1],[0,2,1],[1,2,1]],[[0,0,1],[-1,0,1],[-1,1,1],[0,-2,1],[-1,-2,1]]],Be=[[[0,0,3],[1,0,3],[1,-1,3],[0,2,3],[1,2,3]],[[0,0,3],[1,0,3],[1,1,3],[0,-2,3],[1,-2,3]],[[0,0,3],[-1,0,3],[-1,-1,3],[0,2,3],[-1,2,3]],[[0,0,3],[-1,0,3],[-1,1,3],[0,-2,3],[-1,-2,3]]],Se=[[[0,0,1],[-2,0,1],[1,0,1],[-2,1,1],[1,-2,1]],[[0,0,1],[-1,0,1],[2,0,1],[-1,-2,1],[2,1,1]],[[0,0,1],[2,0,1],[-1,0,1],[2,-1,1],[-1,2,1]],[[0,0,1],[1,0,1],[-2,0,1],[1,2,1],[-2,-1,1]]],be=[[[0,0,3],[-1,0,3],[2,0,3],[-1,-2,3],[2,1,3]],[[0,0,3],[2,0,3],[-1,0,3],[2,-1,3],[-1,2,3]],[[0,0,3],[1,0,3],[-2,0,3],[1,2,3],[-2,-1,3]],[[0,0,3],[-2,0,3],[1,0,3],[-2,1,3],[1,-2,3]]],Ke=10,se=24,xe=[0,0,0,0,0,0,0,0,0,0];function Je(){return Array.from({length:se},()=>xe.slice())}function Ze(e=0,t){const o={};return o.pieceQueue=t,o.pieceQueueIndex=0,o.grid=Je(),o.Next={type:o.pieceQueue[o.pieceQueueIndex]},o.ghostPiece=null,o.linesBeingCleared=null,o.gameOver=!1,o.score=0,o.lines=0,o.level=e,o.speed=oe[e]||50,o.dropTickStart=0,o.softDrop=0,o.levelUp=e*10+10,o.iPieceDrought=0,ce(o),o}function m(e,t,o,n,i){const r=O[t.type][(t.rotation+i)%4];for(const c of r){const l=t.x+o+c[0],s=t.y+n+c[1];if(l<0||l>=Ke||s>=se||s>=0&&e[s][l])return!0}return!1}function Re(e,t){let o=e.y;for(;!m(t,{...e,y:o+1},0,0,0);)o++;return o}function Q(e){if(!e.Block||typeof e.Block.type>"u"){e.ghostPiece=null;return}const t=Re(e.Block,e.grid);e.ghostPiece={...e.Block,y:t}}function ze(e){e.score+=e.softDrop,e.softDrop=0,e.iPieceDrought++;const t=O[e.Block.type][e.Block.rotation];for(const o of t){const n=e.Block.x+o[0],i=e.Block.y+o[1];i>=0&&(e.grid[i][n]=e.Block.type+1)}}function et(e){ze(e);const t=[];for(let o=0;o<se;o++)e.grid[o].every(n=>n!==0)&&t.push(o);if(t.length>0){e.Block.type===Z&&(e.iPieceDrought=0),e.linesBeingCleared=t;const o=t.length;switch(o){case 1:e.score+=40*(e.level+1);break;case 2:e.score+=100*(e.level+1);break;case 3:e.score+=300*(e.level+1);break;case 4:e.score+=1200*(e.level+1);break}e.lines+=o,e.lines>=e.levelUp&&(e.level++,e.levelUp+=10,e.level<oe.length?e.speed=oe[e.level]:e.speed=50)}else ce(e)}function tt(e){if(!e.linesBeingCleared)return;e.linesBeingCleared.sort((o,n)=>n-o).forEach(o=>{e.grid.splice(o,1)});for(let o=0;o<e.linesBeingCleared.length;o++)e.grid.unshift(xe.slice());e.linesBeingCleared=null,ce(e)}function ce(e){e.pieceQueueIndex++,e.pieceQueueIndex>=e.pieceQueue.length&&(e.pieceQueueIndex=0);const t=e.pieceQueue[e.pieceQueueIndex],o={x:3,y:2,rotation:0};if(m(e.grid,{...e.Next,...o},0,0,0)){e.gameOver=!0,e.Block={},Q(e);return}e.Block={...e.Next,...o},e.Next={type:t},Q(e)}function ot(e){m(e.grid,e.Block,-1,0,0)||(e.Block.x--,Q(e))}function nt(e){m(e.grid,e.Block,1,0,0)||(e.Block.x++,Q(e))}function it(e){m(e.grid,e.Block,0,1,0)||(e.Block.y++,e.softDrop++,e.dropTickStart=Date.now())}function Ne(e,t){for(let o=0;o<t.length;o++){const[n,i,r]=t[o];if(!m(e.grid,e.Block,n,i,r)){e.Block.x+=n,e.Block.y+=i,e.Block.rotation=(e.Block.rotation+r)%4,Q(e);return}}}function rt(e){if(!e.Block.type&&e.Block.type!==0||e.Block.type===me)return;const t=e.Block.type===Z?be:Be;Ne(e,t[e.Block.rotation])}function st(e){if(!e.Block.type&&e.Block.type!==0||e.Block.type===me)return;const t=e.Block.type===Z?Se:Ce;Ne(e,t[e.Block.rotation])}function ct(e){if(!e.Block.type&&e.Block.type!==0)return;const t=Re(e.Block,e.grid),o=t-e.Block.y;e.score+=o*2,e.Block.y=t,et(e),e.dropTickStart=Date.now()}const lt=10,at=20,ne=4,ut=`
    attribute vec2 a_position;
    attribute vec4 a_color;

    uniform mat4 u_projectionMatrix;
    
    varying lowp vec4 v_color;

    void main() {
        gl_Position = u_projectionMatrix * vec4(a_position, 0, 1);
        v_color = a_color;
    }
`,ft=`
    precision mediump float;
    varying lowp vec4 v_color;

    void main() {
        gl_FragColor = v_color;
    }
`;function ve(e,t,o){const n=e.createShader(t);return e.shaderSource(n,o),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(n)),e.deleteShader(n),null)}function dt(e,t,o){const n=e.createProgram();return e.attachShader(n,t),e.attachShader(n,o),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)?n:(console.error("Unable to initialize the shader program: "+e.getProgramInfoLog(n)),null)}function ht(e){const t=e.getContext("webgl",{alpha:!0});if(!t)return console.error("WebGL not supported!"),null;const o=ve(t,t.VERTEX_SHADER,ut),n=ve(t,t.FRAGMENT_SHADER,ft),i=dt(t,o,n),r={program:i,attribLocations:{position:t.getAttribLocation(i,"a_position"),color:t.getAttribLocation(i,"a_color")},uniformLocations:{projectionMatrix:t.getUniformLocation(i,"u_projectionMatrix")}};return{gl:t,programInfo:r}}function Pe(e,t){const n=e,i=0,r=t,c=-1,l=1,s=1/(n-0),f=1/(i-r),u=1/(l-c);return[2*s,0,0,0,0,2*f,0,0,0,0,-2*u,0,-(n+0)*s,-(i+r)*f,-0*u,1]}function P(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255]:[0,0,0]}function pt(e,t){return[Math.min(1,e[0]*(1+t)),Math.min(1,e[1]*(1+t)),Math.min(1,e[2]*(1+t))]}function gt(e,t){return[e[0]*(1-t),e[1]*(1-t),e[2]*(1-t)]}function D(e,t,o,n,i,r,c,l=1){e.push(o,n,o+i,n,o,n+r,o,n+r,o+i,n,o+i,n+r);for(let s=0;s<6;s++)t.push(c[0],c[1],c[2],l)}function ie(e,t,o,n,i,r=1){D(e,t,o,n,1,1,[0,0,0],r);const s=o+.05,f=n+.05,u=1-2*.05,a=.15*u,d=.4,h=.4,p=pt(i,d),g=gt(i,h);D(e,t,s,f,u,a,p,r),D(e,t,s,f+u-a,u,a,g,r);const v=f+a,E=u-2*a;D(e,t,s,v,a,E,p,r),D(e,t,s+u-a,v,a,E,g,r),D(e,t,s+a,f+a,u-2*a,u-2*a,i,r)}function At(e,t,o,n,i=0,r=0){const l=O[o.type][o.rotation],s=new Set(l.map(f=>`${f[0]},${f[1]}`));for(const f of l){const[u,a]=f,d=o.x+u+i,h=o.y+a-ne+r;h+1<0||(s.has(`${u},${a+1}`)||D(e,t,d,h+1-.08,1,.08,n,1),s.has(`${u},${a-1}`)||D(e,t,d,h,1,.08,n,1),s.has(`${u-1},${a}`)||D(e,t,d,h,.08,1,n,1),s.has(`${u+1},${a}`)||D(e,t,d+1-.08,h,.08,1,n,1))}}const Ie={0:[[0,0,1,.2],[0,.8,1,.2],[0,0,.2,1],[.8,0,.2,1]],1:[[.4,0,.2,1]],2:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[.8,.4,.2,.4],[0,0,.2,.4]],3:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[.8,0,.2,1]],4:[[0,.4,1,.2],[0,.8,.2,.2],[.8,0,.2,1],[0,.4,.2,.6]],5:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[0,.4,.2,.4],[.8,0,.2,.4]],6:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[0,0,.2,1],[.8,0,.2,.4]],7:[[0,.8,1,.2],[.8,0,.2,1]],8:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[0,0,.2,1],[.8,0,.2,1]],9:[[0,.8,1,.2],[0,.4,1,.2],[.8,0,.2,1],[0,.4,.2,.4]],A:[[0,0,.2,1],[.8,0,.2,1],[.2,.8,.6,.2],[.2,.4,.6,.2]],B:[[0,0,.2,1],[.2,.8,.6,.2],[.8,.4,.2,.4],[.2,.4,.6,.2],[.2,0,.6,.2],[.8,0,.2,.4]],S:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[0,.4,.2,.4],[.8,0,.2,.4]],C:[[0,.8,1,.2],[0,0,1,.2],[0,0,.2,1]],O:[[0,.8,1,.2],[0,0,1,.2],[0,0,.2,1],[.8,0,.2,1]],R:[[0,.8,1,.2],[0,.4,1,.2],[0,0,.2,1],[.8,.4,.2,.6],[.4,.2,.2,.2],[.6,0,.2,.2]],E:[[0,.8,1,.2],[0,.4,1,.2],[0,0,1,.2],[0,0,.2,1]],L:[[0,0,1,.2],[0,0,.2,1]],I:[[.4,0,.2,1]],N:[[0,0,.2,1],[.8,0,.2,1],[.2,.6,.2,.2],[.4,.4,.2,.2],[.6,.2,.2,.2]],V:[[0,.6,.2,.4],[.8,.6,.2,.4],[.2,.3,.2,.3],[.6,.3,.2,.3],[.4,0,.2,.3]],D:[[0,0,.2,1],[.2,.8,.6,.2],[.8,.2,.2,.6],[.2,0,.6,.2]],U:[[0,0,.2,1],[.2,0,.6,.2],[.8,0,.2,1]],G:[[.2,.8,.8,.2],[0,.2,.2,.6],[.2,0,.8,.2],[.8,.2,.2,.4],[.4,.4,.4,.2]],H:[[0,0,.2,1],[.8,0,.2,1],[.2,.4,.6,.2]],T:[[0,.8,1,.2],[.4,0,.2,1]],M:[[0,0,.2,1],[.8,0,.2,1],[.2,.6,.2,.2],[.4,.4,.2,.2],[.6,.6,.2,.2]],K:[[0,0,.2,1],[.8,.4,.2,.6],[.2,.4,.6,.2],[.6,0,.2,.4]]};function w(e,t,o,n,i,r){const c=[],l=[],s=n*.25,f=P(r);let u=t;e=e.toString().toUpperCase();for(const a of e){if(a===" "){u+=n+s;continue}if(Ie[a]){const d=Ie[a];for(const h of d){const[p,g,v,E]=h,y=1-g-E;D(c,l,u+p*n,o+y*i,v*n,E*i,f,1)}}u+=n+s}return{positions:c,colors:l}}function We(e,t=null,o=!1,n=0,i=0,r=0,c=300){const l=[],s=[];for(let f=0;f<at;f++)for(let u=0;u<lt;u++){const a=f+ne,d=e.grid[a][u];if(d){const h=P(Y[d]);let p=1;if(o&&e.linesBeingCleared&&e.linesBeingCleared.includes(a)){const g=Date.now()-n;p=Math.max(0,1-g/c)}ie(l,s,u+i,f+r,h,p)}}if(t){const f=P("#bbbbbb");At(l,s,t,f,i,r)}if(e.Block.type!==void 0&&!e.linesBeingCleared){const f=O[e.Block.type][e.Block.rotation],u=P(Y[e.Block.type+1]);for(const a of f){const d=e.Block.x+a[0]+i,h=e.Block.y+a[1]-ne+r;h>=0&&ie(l,s,d,h,u)}}return{positions:l,colors:s}}function we(e,t=0,o=0){const n=[],i=[];if(e&&e.type!==void 0){const r=O[e.type][0],c=P(Y[e.type+1]);let l=4,s=-1,f=4,u=-1;for(const g of r)l=Math.min(l,g[0]),s=Math.max(s,g[0]),f=Math.min(f,g[1]),u=Math.max(u,g[1]);const a=s-l+1,d=u-f+1,h=(4-a)/2,p=(4-d)/2;for(const g of r){const v=g[0]-l+h+t,E=g[1]-f+p+o;ie(n,i,v,E,c)}}return{positions:n,colors:i}}function Et(e=0){const t=[],o=[],n=P("#444");return D(t,o,e,0,.5,20,n,1),{positions:t,colors:o}}function Oe(e,t,o,n){const i=[],r=[],c=P("#444"),l=.1,s=P(Y[0]);return D(i,r,e,t,o,n,c,1),D(i,r,e+l,t+l,o-2*l,n-2*l,s,1),{positions:i,colors:r}}function vt(e){const t=P(Y[0]);e.clearColor(t[0],t[1],t[2],1),e.clear(e.COLOR_BUFFER_BIT)}function It(e,t,o,n,i){if(n.length===0)return;e.useProgram(t.program),e.uniformMatrix4fv(t.uniformLocations.projectionMatrix,!1,o);const r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array(n),e.STATIC_DRAW),e.enableVertexAttribArray(t.attribLocations.position),e.vertexAttribPointer(t.attribLocations.position,2,e.FLOAT,!1,0,0);const c=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW),e.enableVertexAttribArray(t.attribLocations.color),e.vertexAttribPointer(t.attribLocations.color,4,e.FLOAT,!1,0,0),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.drawArrays(e.TRIANGLES,0,n.length/2),e.disable(e.BLEND)}const M=10,H=24,_t=[0,0,0,0,0,0,0,0,0,0],ke=18,_e=12,te={aggregateHeight:.51,completedLines:-.76,holes:1,bumpiness:.18,lookaheadScore:.8,centerClog:.8,holeReduction:-2.5},Me={aggregateHeight:.4,holes:4,bumpiness:.25,wellClogs:8,lineClearBonus:-5,droughtPenalty:.08,lookaheadScore:.8};function He(e){const t=Array(M).fill(0);for(let o=0;o<M;o++)for(let n=0;n<H;n++)if(e[n][o]){t[o]=H-n;break}return t}function ye(e){return e.reduce((t,o)=>t+o,0)}function K(e){let t=0;for(let o=0;o<M;o++){let n=!1;for(let i=0;i<H;i++)e[i][o]?n=!0:n&&t++}return t}function yt(e){let t=0;for(let o=0;o<e.length-1;o++)t+=Math.abs(e[o]-e[o+1]);return t}function Ge(e){let t=0;const o=[];for(let n=H-1;n>=0;n--)e[n].every(i=>i!==0)?t++:o.unshift(e[n]);for(;o.length<H;)o.unshift(_t.slice());return{grid:o,clearedCount:t}}function $e(e,t,o,n,i,r){const c=He(e);if(o==="rightWell"||o==="leftWell"){const d=o==="rightWell"?9:0,h=o==="rightWell"?8:1,p=K(e),g=n.holes*p;let v=0;for(let I=0;I<M-1;I++)o==="rightWell"&&I===d-1||o==="leftWell"&&I===d||(v+=Math.abs(c[I]-c[I+1]));const E=n.bumpiness*v,y=ye(c),x=n.aggregateHeight*y,R=c[d],S=n.wellClogs*R,C=n.lineClearBonus*(t*t);let B=0;if(i>_e){const I=c[h]-c[d];I>3&&(B=(i-_e)*I*n.droughtPenalty)}return g+E+x+S+C+B}const l=K(e),s=ye(c),f=yt(c);let u=(n.aggregateHeight||0)*s+(n.completedLines||0)*t+(n.holes||0)*l+(n.bumpiness||0)*f;if(r!==null&&t>0){const d=r-l;d>0&&(u+=(n.holeReduction||0)*d)}if(Math.max(...c)>ke){const d=[3,4,5,6];let h=0;for(const p of d)h+=c[p];u+=(n.centerClog||0)*h}return u}function Dt(e,t,o,n,i){let r=1/0;if(!t||typeof t.type>"u")return 0;for(let c=0;c<O[t.type].length;c++){const l={...t,rotation:c};for(let s=-2;s<M;s++){if(l.x=s,m(e,l,0,0,0))continue;let f=0;for(;!m(e,{...l,y:f+1},0,0,0);)f++;l.y=f;const u=JSON.parse(JSON.stringify(e)),a=O[l.type][l.rotation];for(const v of a){const E=l.x+v[0],y=l.y+v[1];y>=0&&y<H&&E>=0&&E<M&&(u[y][E]=l.type+1)}const d=K(u),{grid:h,clearedCount:p}=Ge(u),g=$e(h,p,o,n,i,d);g<r&&(r=g)}}return r}function De(e){return`${e.x},${e.y},${e.rotation}`}function Te(e,t,o){if(t.type===3)return null;const i=(t.type===Z?o==="R"?Se:be:o==="R"?Ce:Be)[t.rotation],r=o==="R"?1:3;for(const c of i){const[l,s]=c;if(!m(e,t,l,s,r))return{...t,x:t.x+l,y:t.y+s,rotation:(t.rotation+r)%4}}return null}function Tt(e,t,o){let n=1/0,i=null,r=null;const c=e.Block,l=e.Next;let s=t;if(t==="rightWell"||t==="leftWell"){const a=He(e.grid);Math.max(...a)>ke&&(s="survival")}if(!c||typeof c.type>"u")return{path:[],target:null};const f=[{piece:c,path:[]}],u=new Set([De(c)]);for(;f.length>0;){const{piece:a,path:d}=f.shift();if(m(e.grid,a,0,1,0)){const p=JSON.parse(JSON.stringify(e.grid)),g=O[a.type][a.rotation];for(const B of g){const I=a.x+B[0],b=a.y+B[1];b>=0&&b<H&&I>=0&&I<M&&(p[b][I]=a.type+1)}const v=K(p),{grid:E,clearedCount:y}=Ge(p),x=$e(E,y,s,o,e.iPieceDrought,v),R=Dt(E,l,s,o,e.iPieceDrought),S=o.lookaheadScore||.8,C=x+R*S;C<n&&(n=C,i=[...d,"hardD"],r=a)}const h=[{name:"moveL",newPiece:{...a,x:a.x-1},isValid:!m(e.grid,a,-1,0,0)},{name:"moveR",newPiece:{...a,x:a.x+1},isValid:!m(e.grid,a,1,0,0)},{name:"softD",newPiece:{...a,y:a.y+1},isValid:!m(e.grid,a,0,1,0)},{name:"rotateR",newPiece:Te(e.grid,a,"R")},{name:"rotateL",newPiece:Te(e.grid,a,"L")}];for(const p of h)if(p.newPiece&&(p.isValid===void 0||p.isValid)){const g=De(p.newPiece);u.has(g)||(u.add(g),f.push({piece:p.newPiece,path:[...d,p.name]}))}}return{path:i||["hardD"],target:r}}function Lt(e,t=.1){const o={...e};for(const n in o){const i=e[n];if(i===0)continue;const r=i<0?t/1.5:t,c=(Math.random()-.5)*2*r;let l=i*(1+c);i*l<0&&(l=i),o[n]=l}return o}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/const Ve=document.querySelector("h1"),le=document.getElementById("main-container"),Ue=document.getElementById("startlevel"),mt=document.getElementById("reset-button"),ae=document.getElementById("training-mode-button"),Fe=document.getElementById("speed-slider"),F=document.getElementById("speed-label");class re{constructor(t,o,n,i,r){this.isClearing=!1,this.clearStartTime=0,this.aiState="PLANNING",this.aiMoveQueue=[],this.aiTargetPiece=null,this.aiNextActionTime=0,this.aiActionInProgress=!1,this.aiCurrentActionType=null,this.aiCurrentActionCount=0,this.id=t,this.strategy=o,this.weights=n,this.canvas=i,this.renderer=ht(this.canvas),this.projectionMatrix=r}reset(t,o){this.state=Ze(t,o),this.isClearing=!1,this.clearStartTime=0,this.resetAiExecutionState()}resetAiExecutionState(){this.aiState="PLANNING",this.aiMoveQueue=[],this.aiTargetPiece=null,this.aiActionInProgress=!1,this.aiCurrentActionType=null,this.aiCurrentActionCount=0,this.aiNextActionTime=Date.now()}handleAiAction(t){switch(t){case"moveL":ot(this.state);break;case"moveR":nt(this.state);break;case"rotateL":rt(this.state);break;case"rotateR":st(this.state);break;case"softD":it(this.state);break;case"hardD":ct(this.state);break}}}let k="battle",X,J=[];const Ct=1e4;let A=[],G={...Me},z=null;const W={AI_PLANNING_DELAY:100,AI_ACTION_DELAY:40,timeDelayDas:120,timeDelayARE:40,CLEAR_DELAY:300};let _={...W};function Ye(){const e=parseInt(Fe.value,10),t=e/50;k==="training"?(_.AI_PLANNING_DELAY=0,_.CLEAR_DELAY=0,_.AI_ACTION_DELAY=0,_.timeDelayDas=W.timeDelayDas*t,_.timeDelayARE=W.timeDelayARE*t):(_.AI_PLANNING_DELAY=W.AI_PLANNING_DELAY*t,_.AI_ACTION_DELAY=W.AI_ACTION_DELAY*t,_.timeDelayDas=W.timeDelayDas*t,_.timeDelayARE=W.timeDelayARE*t,_.CLEAR_DELAY=Math.max(50,W.CLEAR_DELAY*t)),e===0?F.textContent="Superhuman":e<40?F.textContent="Fast":e<60?F.textContent="Normal":e<85?F.textContent="Slow":F.textContent="Very Slow"}function Bt(e){if(e.isClearing){Date.now()-e.clearStartTime>_.CLEAR_DELAY&&(e.isClearing=!1,tt(e.state),e.resetAiExecutionState());return}if(e.state.linesBeingCleared){e.isClearing=!0,e.clearStartTime=Date.now(),e.aiMoveQueue=[],e.aiTargetPiece=null;return}if(!e.state.gameOver&&!(Date.now()<e.aiNextActionTime)){if(e.aiState==="PLANNING"){const{path:t,target:o}=Tt(e.state,e.strategy,e.weights);e.aiMoveQueue=t,e.aiTargetPiece=o,e.aiState="EXECUTING",e.aiNextActionTime=Date.now()}else if(e.aiState==="EXECUTING")if(e.aiActionInProgress)e.handleAiAction(e.aiCurrentActionType),e.aiCurrentActionCount--,e.aiCurrentActionCount>0?e.aiNextActionTime=Date.now()+_.timeDelayARE:(e.aiActionInProgress=!1,e.aiNextActionTime=Date.now());else if(e.aiMoveQueue.length===0)e.aiState="PLANNING",e.aiNextActionTime=Date.now()+_.AI_PLANNING_DELAY;else{const t=e.aiMoveQueue.shift();if(t==="moveL"||t==="moveR"){let o=1;for(;e.aiMoveQueue.length>0&&e.aiMoveQueue[0]===t;)e.aiMoveQueue.shift(),o++;e.handleAiAction(t),o>1?(e.aiActionInProgress=!0,e.aiCurrentActionType=t,e.aiCurrentActionCount=o-1,e.aiNextActionTime=Date.now()+_.timeDelayDas):e.aiNextActionTime=Date.now()+_.AI_ACTION_DELAY}else e.handleAiAction(t),t==="hardD"?(e.aiState="PLANNING",e.aiNextActionTime=Date.now()+_.AI_PLANNING_DELAY):e.aiNextActionTime=Date.now()+_.AI_ACTION_DELAY}}}function St(){if(A.length===0||!A[0].renderer)return;const e=A[0].renderer,t=A[0].projectionMatrix;vt(e.gl);let o=[],n=[];if(k==="battle")for(const i of A){const r=bt(i);o.push(...r.positions),n.push(...r.colors)}else A.forEach((i,r)=>{const c=xt(i,r);o.push(...c.positions),n.push(...c.colors)});It(e.gl,e.programInfo,t,o,n)}const T=.3,L=.55,N=.9,$="#cccccc",V="#f0f000";function U(e,t,o,n,i,r){const c=e.toString(),l=c.length*(n*1.25)-n*.25;return w(c,t-l,o,n,i,r)}function bt(e){const c=e.id===1,l=c?5:15+.5,s=c?1/2:l+10+1/2,f=14,u=We(e.state,e.aiTargetPiece,e.isClearing,e.clearStartTime,l,0,_.CLEAR_DELAY),a=Oe(s,f,4,4),d=we(e.state.Next,s,f),h=12,p=s,g=s+4,v=w("SCORE",p,h,T,L,$),E=U(e.state.score,g,h,T,L,V),y=w("LINES",p,h-N,T,L,$),x=U(e.state.lines,g,h-N,T,L,V),R=w("LEVEL",p,h-2*N,T,L,$),S=U(e.state.level,g,h-2*N,T,L,V);let C=[...u.positions,...a.positions,...d.positions,...v.positions,...E.positions,...y.positions,...x.positions,...R.positions,...S.positions],B=[...u.colors,...a.colors,...d.colors,...v.colors,...E.colors,...y.colors,...x.colors,...R.colors,...S.colors];if(e.strategy==="rightWell"||e.strategy==="leftWell"){const I=w("DROUGHT",p,h-3*N,T,L,$),b=U(e.state.iPieceDrought,g,h-3*N,T,L,V);C.push(...I.positions,...b.positions),B.push(...I.colors,...b.colors)}if(c){const I=Et(15);C.push(...I.positions),B.push(...I.colors)}return{positions:C,colors:B}}function xt(e,t){const l=t%3,s=Math.floor(t/3),f=l*15.5,u=s*20,a=10,d=4,h=4,p=f+.5,g=p+a+.5,v=u+14,E=We(e.state,e.aiTargetPiece,e.isClearing,e.clearStartTime,p,u,_.CLEAR_DELAY),y=Oe(g,v,d,h),x=we(e.state.Next,g,v),R=`AI ${e.id}`,S=T*1.1,C=L*1.1,B=R.length*(S*1.25)-S*.25,I=g+d/2-B/2,b=v-C-.3,fe=w(R,I,b,S,C,"#ffffff"),j=b-N,de=g,he=g+d,pe=w("SCORE",de,j,T,L,$),ge=U(e.state.score,he,j,T,L,V),Ae=w("LINES",de,j-N,T,L,$),Ee=U(e.state.lines,he,j-N,T,L,V),je=[...E.positions,...y.positions,...x.positions,...fe.positions,...pe.positions,...ge.positions,...Ae.positions,...Ee.positions],qe=[...E.colors,...y.colors,...x.colors,...fe.colors,...pe.colors,...ge.colors,...Ae.colors,...Ee.colors];return{positions:je,colors:qe}}function ue(){if(A.forEach(Bt),St(),k==="training"&&A.every(o=>o.state.gameOver||o.state.lines>=200)&&A.length>0){let o=null,n=-1;for(const i of A){const r=i.state.lines>0?i.state.score/i.state.lines:-1;r>n&&(n=r,o=i)}o&&n>-1?(console.log(`Training session complete. New baseline from AI ${o.id} (Score/Lines: ${n.toFixed(2)}).`),G={...o.weights}):console.log("All games failed to clear any lines. Restarting with same baseline."),ee();return}X=requestAnimationFrame(ue)}function Qe(){J=[];for(let e=0;e<Ct;e++)J.push(Math.floor(Math.random()*7))}function Rt(e){k!=="training"||!A[e]||(console.log(`Selecting AI ${A[e].id} as new baseline.`),G={...A[e].weights},ee())}function Nt(e){k!=="training"||!A[e]||(console.log(`Using AI ${A[e].id} in battle mode.`),z={...A[e].weights},Xe())}function Le(e,t){return`
        <div class="strategy-selector">
            <label for="${e}">Strategy</label>
            <select name="${e}" id="${e}">
                ${z?`<option value="trained" ${t==="trained"?"selected":""}>Trained AI</option>`:""}
                <option value="rightWell" ${t==="rightWell"?"selected":""}>Right Well</option>
                <option value="leftWell" ${t==="leftWell"?"selected":""}>Left Well</option>
                <option value="survival" ${t==="survival"?"selected":""}>Survival</option>
            </select>
        </div>
    `}function Pt(){const e=z?"trained":"rightWell";le.innerHTML=`
      <div id="battle-container">
        <div class="side-info" id="side-info-1">
            <h2>LEFT AI</h2>
            ${Le("left-strategy","survival")}
        </div>
        <div id="board-wrapper">
            <canvas id="battle-canvas" width="610" height="400"></canvas>
        </div>
        <div class="side-info" id="side-info-2">
            <h2>RIGHT AI</h2>
            ${Le("right-strategy",e)}
        </div>
      </div>
    `}function Wt(){le.innerHTML=`
        <div id="training-container">
            <div id="board-wrapper">
                <canvas id="training-canvas" width="465" height="600"></canvas>
            </div>
            <div id="training-info-grid">
                ${Array.from({length:9},(e,t)=>t+1).map(e=>`
                    <div class="training-info-panel" id="training-info-panel-${e}">
                        <div class="weights-display" id="weights-display-${e}"></div>
                        <div class="info-button-container">
                            <button class="baseline-button" data-index="${e-1}">MAKE BASELINE</button>
                            <button class="use-battle-button" data-index="${e-1}">USE IN BATTLE</button>
                        </div>
                    </div>
                `).join("")}
            </div>
        </div>
    `,document.querySelectorAll(".baseline-button").forEach(e=>{e.addEventListener("click",t=>{const o=parseInt(t.target.dataset.index,10);Rt(o)})}),document.querySelectorAll(".use-battle-button").forEach(e=>{e.addEventListener("click",t=>{const o=parseInt(t.target.dataset.index,10);Nt(o)})})}function q(e){switch(e){case"trained":return z||te;case"survival":return te;case"rightWell":case"leftWell":return Me;default:return te}}function wt(){Ve.textContent="TETRIS AI BATTLE",ae.textContent="Enter Training Mode",Pt();const e=document.getElementById("battle-canvas"),t=Pe(30.5,20),o=document.getElementById("left-strategy"),n=document.getElementById("right-strategy"),i=o.value,r=n.value,c=q(i),l=q(r);A=[new re(1,i,c,e,t),new re(2,r,l,e,t)],o.addEventListener("change",()=>{if(A[0]){const s=o.value;A[0].strategy=s,A[0].weights=q(s),A[0].resetAiExecutionState()}}),n.addEventListener("change",()=>{if(A[1]){const s=n.value;A[1].strategy=s,A[1].weights=q(s),A[1].resetAiExecutionState()}})}function Ot(){Ve.textContent="AI TRAINING MODE",ae.textContent="Back to Battle",Wt(),A=[];const e=document.getElementById("training-canvas"),t=Pe(46.5,60);for(let o=1;o<=9;o++){const n=o===1?G:Lt(G,.2),i=new re(o,"rightWell",n,e,t);A.push(i);const r=document.getElementById(`weights-display-${o}`);if(!r)continue;let c="";const l=[];if(o===1){c="<h4>AI 1 BASELINE</h4>";for(const s in n)l.push(`
                    <div class="weight-entry">
                        <span class="weight-name" title="${s}">${s}</span>
                        <span class="weight-value">${n[s].toFixed(3)}</span>
                    </div>
                `)}else{c=`<h4>AI ${o} MUTATIONS</h4>`;for(const s in G){const f=G[s],u=n[s],a=u-f;if(Math.abs(a)>1e-9&&f!==0){const d=a/f*100,h=d>0?"positive-change":"negative-change",p=d>0?"+":"";l.push(`
                        <div class="weight-entry">
                            <span class="weight-name" title="${s}">${s}</span>
                            <span class="weight-value">${u.toFixed(3)}</span>
                            <span class="weight-change ${h}">(${p}${d.toFixed(1)}%)</span>
                        </div>
                    `)}}}o>1&&l.length===0?c+='<div class="no-change-note">No significant mutations.</div>':c+=l.join(""),r.innerHTML=c}}function kt(){X&&cancelAnimationFrame(X),Qe();const e=parseInt(Ue.value,10)||0;for(const t of A)t.reset(e,J);ue()}function ee(){X&&cancelAnimationFrame(X),Qe();const e=parseInt(Ue.value,10)||0;A=[],le.innerHTML="",k==="battle"?wt():Ot();for(const t of A)t.reset(e,J);Ye(),ue()}function Xe(){k=k==="battle"?"training":"battle",ee()}mt.addEventListener("click",kt);ae.addEventListener("click",Xe);Fe.addEventListener("input",Ye);ee();
